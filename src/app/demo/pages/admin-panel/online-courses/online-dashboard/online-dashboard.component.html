<app-loading-overlay [isLoading]="pageLoading">
  <div class="row">
  <div class="col-12" *ngIf="overviewError">
    <app-card [showHeader]="false" [padding]="20">
      <div class="text-warn-500">{{ overviewError }}</div>
    </app-card>
  </div>

  <div class="col-12" *ngIf="overviewLoading">
    <app-card [showHeader]="false" [padding]="20">
      <div class="flex align-item-center justify-content-center text-muted">
        {{ 'جاري تحميل نظرة عامة لوحة التحكم…' | translate }}
      </div>
    </app-card>
  </div>

  @if (!overviewLoading && visibleRoleMetricCards.length) {
    <div class="col-12">
      <h5 class="section-title">{{ 'إحصائيات الأدوار' | translate }}</h5>
    </div>

    @for (metric of visibleRoleMetricCards; track metric.key) {
      <div class="col-lg-3 col-md-6">
        <ng-container *ngIf="metric.link; else staticRoleCard">
          <a class="role-metric-link" [routerLink]="metric.link">
            <app-card [showHeader]="false" [padding]="18" cardClass="role-metric-card role-metric-card--clickable">
              <div class="flex align-item-center justify-content-between">
                <div class="flex-grow-1">
                  <p class="m-b-5 f-w-600 text-muted">{{ metric.title | translate }}</p>
                  <div class="f-18 f-w-700">{{ metric.value }}</div>
                </div>
                <div class="metric-icon {{ metric.background }}">
                  <svg class="pc-icon">
                    <use attr.xlink:href="assets/fonts/custom-icon.svg{{ metric.icon }}"></use>
                  </svg>
                </div>
              </div>
            </app-card>
          </a>
        </ng-container>
        <ng-template #staticRoleCard>
          <app-card [showHeader]="false" [padding]="18" cardClass="role-metric-card">
            <div class="flex align-item-center justify-content-between">
              <div class="flex-grow-1">
                <p class="m-b-5 f-w-600 text-muted">{{ metric.title | translate }}</p>
                <div class="f-18 f-w-700">{{ metric.value }}</div>
              </div>
              <div class="metric-icon {{ metric.background }}">
                <svg class="pc-icon">
                  <use attr.xlink:href="assets/fonts/custom-icon.svg{{ metric.icon }}"></use>
                </svg>
              </div>
            </div>
          </app-card>
        </ng-template>
      </div>
    }
  }

  @if (!isTeacher && !overviewLoading && financialMetricCards.length) {
    <div class="col-12">
      <h5 class="section-title">{{ 'المعاملات المالية' | translate }}</h5>
    </div>

    @for (finance of financialMetricCards; track finance.key) {
      <div class="col-lg-3 col-md-6">
        <app-card [showHeader]="false" [padding]="18" cardClass="role-metric-card finance-card">
          <div class="flex align-item-center justify-content-between">
            <div class="flex-grow-1">
              <p class="m-b-5 f-w-600 text-muted">{{ finance.title | translate }}</p>
              <div class="f-18 f-w-700">{{ finance.value }}</div>
            </div>
            <div class="metric-icon {{ finance.background }}">
              <svg class="pc-icon">
                <use attr.xlink:href="assets/fonts/custom-icon.svg{{ finance.icon }}"></use>
              </svg>
            </div>
          </div>
        </app-card>
      </div>
    }
  }

  @if (!isTeacher && !overviewLoading && !summaryCards.length && overviewLoaded) {
    <div class="col-12">
      <app-card [showHeader]="false" [padding]="20">
        <div class="text-muted">{{ 'لا توجد إحصائيات للوحة التحكم في هذه المدة.' | translate }}</div>
      </app-card>
    </div>
  }

  <div class="col-12" *ngIf="!isTeacher && overviewLoaded && (overviewRoleLabel || overviewRangeDescription)">
    <div class="text-muted f-12 m-b-20">
      <span *ngIf="overviewRoleLabel"><strong>{{ 'الدور' | translate }}:</strong> {{ overviewRoleLabel }}</span>
      <span *ngIf="overviewRoleLabel && overviewRangeDescription"> · </span>
      <span *ngIf="overviewRangeDescription"><strong>{{ 'المدة' | translate }}:</strong> {{ overviewRangeDescription }}</span>
    </div>
  </div>

  <div class="col-12" *ngIf="!isTeacher && financialChartHasData">
    <app-statistics-chart
      [height]="260"
      [chartTitle]="'تحليل المعاملات المالية' | translate"
      [chartSubtitle]="overviewRangeDescription"
      [series]="financialChartSeries"
      [categories]="financialChartCategories"
      [showRangeSelector]="false"
    />
  </div>
  <div class="col-12" *ngIf="!isTeacher && !financialChartHasData && financialMetricCards.length && overviewLoaded">
    <app-card [showHeader]="false" [padding]="24">
      <div class="text-muted">{{ 'لا توجد بيانات مالية متاحة لهذه المدة.' | translate }}</div>
    </app-card>
  </div>

  <div class="col-lg-7 col-md-12" *ngIf="!isTeacher && monthlyRevenueHasData">
    <app-statistics-chart
      [height]="300"
      [chartTitle]="'الإيرادات الشهرية' | translate"
      [chartSubtitle]="overviewRangeDescription"
      [series]="monthlyRevenueSeries"
      [categories]="monthlyRevenueCategories"
      [showRangeSelector]="false"
    />
  </div>
  <div class="col-lg-7 col-md-12" *ngIf="!isTeacher && !monthlyRevenueHasData && overviewLoaded">
    <app-card [showHeader]="false" [padding]="24">
      <div class="text-muted">{{ 'لا توجد بيانات للإيرادات الشهرية في هذه المدة.' | translate }}</div>
    </app-card>
  </div>

  <div class="col-12">
    <app-card [cardTitle]="'الحصص  القادمة' | translate" [padding]="0" cardClass="upcoming-course">
      <div class="upcoming-table">
        <div class="upcoming-row upcoming-header">
          <div class="col-course">{{ 'الحلقة' | translate }}</div>
          <div class="col-schedule">{{ 'الجدول' | translate }}</div>
          <div class="col-managers">{{ 'المديرون' | translate }}</div>
          <div class="col-teacher">{{ 'المعلم' | translate }}</div>
        </div>

        <div class="upcoming-row" *ngIf="upcomingLoading">
          <div class="col-full">{{ 'جاري تحميل الحلقات القادمة…' | translate }}</div>
        </div>

        <div class="upcoming-row" *ngIf="!upcomingLoading && !upcomingCircles.length">
          <div class="col-full">{{ 'لا توجد حلقات قادمة' | translate }}</div>
        </div>

        @for (circle of upcomingCircles; track circle?.id ?? circle?.name ?? circle) {
          <div class="upcoming-row">
            <div class="col-course">
              <div class="course-info">
                <div class="avatar avatar-s bg-primary-50 text-primary-500 f-w-600">
                  {{ getCircleInitials(circle.name) }}
                </div>
                <div class="course-text">
                  <div class="course-name">{{ circle.name || ('حلقة بدون اسم' | translate) }}</div>
                  <div class="course-meta">{{ getUpcomingScheduleLabel(circle) || ('الجدول غير محدد' | translate) }}</div>
                </div>
              </div>
            </div>
            <div class="col-schedule text-muted">
              {{ getUpcomingScheduleLabel(circle) || ('الجدول غير محدد' | translate) }}
            </div>
            <div class="col-managers text-muted">
              {{ getUpcomingManagersLabel(circle) || '—' }}
            </div>
            <div class="col-teacher">
              <ng-container *ngIf="getUpcomingTeacherName(circle) as teacher; else teacherPlaceholder">
                <span class="teacher-pill">{{ teacher }}</span>
              </ng-container>
              <ng-template #teacherPlaceholder>—</ng-template>
            </div>
          </div>
        }
      </div>
    </app-card>
  </div>

  <div class="col-12" *ngIf="!isTeacher && transactionsView.length">
    <app-card [cardTitle]="'المعاملات الأخيرة' | translate" padding="0">
      <div class="table-responsive transactions-table">
        <table class="table table-hover m-b-0">
          <thead>
            <tr>
              <th>{{ 'الطالب' | translate }}</th>
              <th>{{ 'المبلغ' | translate }}</th>
              <th>{{ 'التاريخ' | translate }}</th>
              <th>{{ 'الحالة' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (transaction of transactionsView; track transaction.key) {
              <tr>
                <td class="student-cell">{{ transaction.student }}</td>
                <td class="amount-cell">{{ transaction.amount }}</td>
                <td class="date-cell">{{ transaction.date }}</td>
                <td>
                  <span class="status-pill {{ transaction.statusClass }}">{{ transaction.status }}</span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </app-card>
  </div>

  <div class="col-12" *ngIf="!isTeacher && overviewLoaded && !transactionsView.length">
    <app-card [showHeader]="false" [padding]="20">
      <div class="text-muted">{{ 'لا توجد معاملات حديثة لهذه المدة.' | translate }}</div>
    </app-card>
  </div>
  </div>
</app-loading-overlay>

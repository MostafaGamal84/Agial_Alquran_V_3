<app-loading-overlay [isLoading]="pageLoading">
  <div class="row">
  <div class="col-12" *ngIf="overviewError">
    <app-card [showHeader]="false" [padding]="20">
      <div class="text-warn-500">{{ overviewError }}</div>
    </app-card>
  </div>

  <div class="col-12" *ngIf="overviewLoading">
    <app-card [showHeader]="false" [padding]="20">
      <div class="flex align-item-center justify-content-center text-muted">
        {{ 'جاري تحميل نظرة عامة لوحة التحكم…' | translate }}
      </div>
    </app-card>
  </div>

  @if (!overviewLoading && summaryCards.length) {
    @for (summary of summaryCards; track summary.key) {
      <div class="col-lg-3 col-md-6">
        <app-card [showHeader]="false" [padding]="20">
          <div class="flex align-item-center">
            <div class="flex-shrink-0">
              <div class="avatar avatar-s {{ summary.background }}">
                <svg class="pc-icon">
                  <use attr.xlink:href="assets/fonts/custom-icon.svg{{ summary.icon }}"></use>
                </svg>
              </div>
            </div>
            <div class="flex-grow-1 m-l-15">
              <p class="m-b-5 f-w-500">{{ summary.title | translate }}</p>
              <div class="flex align-item-center justify-content-between">
                <div class="f-16 f-w-600">{{ summary.value }}</div>
                <span *ngIf="summary.percentage as percent" class="{{ summary.percentageClass ?? 'text-muted' }}">
                  {{ percent }}
                </span>
              </div>
            </div>
          </div>
        </app-card>
      </div>
    }
  }

  @if (!overviewLoading && roleMetricCards.length) {
    <div class="col-12">
      <h5 class="section-title">{{ 'إحصائيات الأدوار' | translate }}</h5>
    </div>

    @for (metric of roleMetricCards; track metric.key) {
      <div class="col-lg-3 col-md-6">
        <app-card [showHeader]="false" [padding]="18" cardClass="role-metric-card">
          <div class="flex align-item-center justify-content-between">
            <div class="flex-grow-1">
              <p class="m-b-5 f-w-600 text-muted">{{ metric.title | translate }}</p>
              <div class="f-18 f-w-700">{{ metric.value }}</div>
            </div>
            <div class="metric-icon {{ metric.background }}">
              <svg class="pc-icon">
                <use attr.xlink:href="assets/fonts/custom-icon.svg{{ metric.icon }}"></use>
              </svg>
            </div>
          </div>
        </app-card>
      </div>
    }
  }

  @if (!overviewLoading && financialMetricCards.length) {
    <div class="col-12">
      <h5 class="section-title">{{ 'المعاملات المالية' | translate }}</h5>
    </div>

    @for (finance of financialMetricCards; track finance.key) {
      <div class="col-lg-3 col-md-6">
        <app-card [showHeader]="false" [padding]="18" cardClass="role-metric-card finance-card">
          <div class="flex align-item-center justify-content-between">
            <div class="flex-grow-1">
              <p class="m-b-5 f-w-600 text-muted">{{ finance.title | translate }}</p>
              <div class="f-18 f-w-700">{{ finance.value }}</div>
            </div>
            <div class="metric-icon {{ finance.background }}">
              <svg class="pc-icon">
                <use attr.xlink:href="assets/fonts/custom-icon.svg{{ finance.icon }}"></use>
              </svg>
            </div>
          </div>
        </app-card>
      </div>
    }
  }

  @if (!overviewLoading && !summaryCards.length && overviewLoaded) {
    <div class="col-12">
      <app-card [showHeader]="false" [padding]="20">
        <div class="text-muted">{{ 'لا توجد إحصائيات للوحة التحكم في هذه المدة.' | translate }}</div>
      </app-card>
    </div>
  }

  <div class="col-12" *ngIf="overviewLoaded && (overviewRoleLabel || overviewRangeDescription)">
    <div class="text-muted f-12 m-b-20">
      <span *ngIf="overviewRoleLabel"><strong>{{ 'الدور' | translate }}:</strong> {{ overviewRoleLabel }}</span>
      <span *ngIf="overviewRoleLabel && overviewRangeDescription"> · </span>
      <span *ngIf="overviewRangeDescription"><strong>{{ 'المدة' | translate }}:</strong> {{ overviewRangeDescription }}</span>
    </div>
  </div>

  <div class="col-12" *ngIf="financialChartHasData">
    <app-statistics-chart
      [height]="260"
      [chartTitle]="'تحليل المعاملات المالية' | translate"
      [chartSubtitle]="overviewRangeDescription"
      [series]="financialChartSeries"
      [categories]="financialChartCategories"
      [showRangeSelector]="false"
    />
  </div>
  <div class="col-12" *ngIf="!financialChartHasData && financialMetricCards.length && overviewLoaded">
    <app-card [showHeader]="false" [padding]="24">
      <div class="text-muted">{{ 'لا توجد بيانات مالية متاحة لهذه المدة.' | translate }}</div>
    </app-card>
  </div>

  <div class="col-lg-7 col-md-12" *ngIf="monthlyRevenueHasData">
    <app-statistics-chart
      [height]="300"
      [chartTitle]="'الإيرادات الشهرية' | translate"
      [chartSubtitle]="overviewRangeDescription"
      [series]="monthlyRevenueSeries"
      [categories]="monthlyRevenueCategories"
      [showRangeSelector]="false"
    />
  </div>
  <div class="col-lg-7 col-md-12" *ngIf="!monthlyRevenueHasData && overviewLoaded">
    <app-card [showHeader]="false" [padding]="24">
      <div class="text-muted">{{ 'لا توجد بيانات للإيرادات الشهرية في هذه المدة.' | translate }}</div>
    </app-card>
  </div>

  <div class="col-lg-5 col-md-12" *ngIf="projectOverviewEntries.length">
    <app-card [cardTitle]="'نظرة عامة على المشروع' | translate" [padding]="0" cardClass="metric-list">
      <ul class="list-group list-group-flush">
        @for (item of projectOverviewEntries; track item.key) {
          <li class="list-group-item">
            <span class="metric-label">{{ item.label | translate }}</span>
            <span class="metric-value">{{ item.value }}</span>
          </li>
        }
      </ul>
    </app-card>
  </div>

  <div class="col-lg-7 col-md-12">
    <app-card [cardTitle]="'الدورات القادمة' | translate" [padding]="0" cardClass="upcoming-course">
      <ul class="list-group list-group-flush">
        <li class="list-group-item" *ngIf="upcomingLoading">
          <div class="flex align-item-center">{{ 'جاري تحميل الحلقات القادمة…' | translate }}</div>
        </li>
        <li class="list-group-item" *ngIf="!upcomingLoading && !upcomingCircles.length">
          <div class="flex align-item-center">{{ 'لا توجد حلقات قادمة' | translate }}</div>
        </li>
        @for (circle of upcomingCircles; track circle?.id ?? circle?.name ?? circle) {
          <li class="list-group-item">
            <div class="flex align-item-center">
              <div class="flex-shrink-0 flex">
                <div class="avatar avatar-s bg-primary-50 text-primary-500 f-w-600">
                  {{ getCircleInitials(circle.name) }}
                </div>
              </div>
              <div class="flex-grow-1 m-x-15">
                <div class="f-14 f-w-600">{{ circle.name || ('حلقة بدون اسم' | translate) }}</div>
                <div class="text-muted f-12">
                  {{ getUpcomingScheduleLabel(circle) || ('الجدول غير محدد' | translate) }}
                </div>
                <div class="text-muted f-12" *ngIf="getUpcomingManagersLabel(circle) as managers">
                  {{ 'المديرون' | translate }}: {{ managers }}
                </div>
              </div>
              <div class="flex-shrink-0" *ngIf="getUpcomingTeacherName(circle) as teacher">
                <span class="badge bg-light-primary text-primary-500 f-12">{{ teacher }}</span>
              </div>
            </div>
          </li>
        }
      </ul>
    </app-card>
  </div>

  <div class="col-12" *ngIf="transactionsView.length">
    <app-card [cardTitle]="'المعاملات الأخيرة' | translate" padding="0">
      <div class="table-responsive">
        <table class="table table-hover m-b-0">
          <thead>
            <tr>
              <th class="text-nowrap">{{ 'الطالب' | translate }}</th>
              <th class="text-nowrap">{{ 'المبلغ' | translate }}</th>
              <th class="text-nowrap">{{ 'التاريخ' | translate }}</th>
              <th class="text-nowrap">{{ 'الحالة' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (transaction of transactionsView; track transaction.key) {
              <tr>
                <td class="text-nowrap">{{ transaction.student }}</td>
                <td class="text-nowrap">{{ transaction.amount }}</td>
                <td class="text-nowrap">{{ transaction.date }}</td>
                <td class="text-nowrap">
                  <span class="{{ transaction.statusClass }}">{{ transaction.status | translate }}</span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </app-card>
  </div>

  <div class="col-12" *ngIf="overviewLoaded && !transactionsView.length">
    <app-card [showHeader]="false" [padding]="20">
      <div class="text-muted">{{ 'لا توجد معاملات حديثة لهذه المدة.' | translate }}</div>
    </app-card>
  </div>
  </div>
</app-loading-overlay>

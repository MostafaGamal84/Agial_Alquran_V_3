<div class="dialog-head" mat-dialog-title>
  <div class="head-row">
    <div class="title">بيانات المعلم</div>

    <button mat-icon-button class="close-btn" mat-dialog-close aria-label="إغلاق">
      <i class="ti ti-x"></i>
    </button>
  </div>
</div>

<mat-dialog-content class="dialog-content">
  <!-- حالة التحميل -->
  <div class="loading-state" *ngIf="loading">
    <mat-spinner diameter="48"></mat-spinner>
    <div class="loading-text">جاري تحميل بيانات المعلم...</div>
  </div>

  <!-- المحتوى الرئيسي -->
  <app-scrollbar
    *ngIf="!loading && vm as t"
    [customStyle]="{ maxHeight: 'calc(100vh - 155px)', position: 'relative' }"
  >
    <div class="wrap">
      <!-- ====== كرت الهيدر (المعلم) ====== -->
      <section class="card hero">
        <div class="hero-left">
          <div class="avatar">
            <i class="ti ti-user"></i>
          </div>

          <div class="hero-meta">
            <div class="name">{{ t.fullName || 'غير متوفر' }}</div>

            <div class="sub">
              <span class="pill">
                <i class="ti ti-building-store"></i>
                {{ getBranchLabel(t.branchId) || 'فرع غير محدد' }}
              </span>

              <!-- حالة النشاط (اختياري لاحقًا)
              <span class="pill" *ngIf="t.inactive !== undefined" [class.is-inactive]="!!t.inactive">
                <i
                  class="ti"
                  [class.ti-circle-check]="!t.inactive"
                  [class.ti-circle-x]="!!t.inactive"
                ></i>
                {{ t.inactive ? 'غير نشط' : 'نشط' }}
              </span>
              -->
            </div>
          </div>
        </div>

        <div class="hero-right" *ngIf="statEntries.length">
          <div class="mini" *ngFor="let s of statEntries">
            <div class="mini-k">{{ s.label }}</div>
            <div class="mini-v">{{ s.value || 'غير متوفر' }}</div>
          </div>
        </div>
      </section>

      <!-- ====== كرت بيانات التواصل ====== -->
      <section class="card" *ngIf="contactEntries.length">
        <div class="card-title">
          <i class="ti ti-address-book"></i>
          بيانات التواصل
        </div>

        <div class="contact-grid">
          <a
            class="contact-item"
            *ngFor="let c of contactEntries"
            [href]="c.href || null"
            [class.is-link]="!!c.href"
            (mousedown)="onContactPressStart(c.value, $event)"
            (mouseup)="onContactPressEnd()"
            (mouseleave)="onContactPressEnd()"
            (touchstart)="onContactPressStart(c.value, $event)"
            (touchend)="onContactPressEnd()"
            (touchcancel)="onContactPressEnd()"
            (click)="onContactClick($event)"
          >
            <div class="c-ico"><i [class]="c.icon"></i></div>

            <div class="c-body" *ngIf="!isCompactContact(c.key)">
              <div class="c-label">{{ c.label }}</div>
              <div class="c-value">{{ c.value || 'غير متوفر' }}</div>
            </div>

            <i class="ti ti-external-link hint" *ngIf="c.href && !isCompactContact(c.key)"></i>
          </a>
        </div>
      </section>

      <!-- ====== كرت البيانات الأساسية ====== -->
      <section class="card" *ngIf="detailEntries.length">
        <div class="card-title">
          <i class="ti ti-id"></i>
          البيانات الأساسية
        </div>

        <div class="kv-grid">
          <div class="kv" *ngFor="let e of detailEntries">
            <div class="k">{{ e.label }}</div>
            <div class="v">{{ e.value || 'غير متوفر' }}</div>
          </div>
        </div>
      </section>

      <!-- ====== كرت الارتباطات (الطلاب) ====== -->
      <section class="card" *ngIf="students.length">
        <div class="card-title">
          <i class="ti ti-list-details"></i>
          الارتباطات
        </div>

        <mat-accordion class="acc">
          <!-- الطلاب -->
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                الطلاب
                <span class="count">{{ students.length }}</span>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="rows">
              <div class="row" *ngFor="let s of students">
                <div class="row-main">
                  <div class="row-title">{{ s.fullName || 'غير متوفر' }}</div>
                  <div class="row-sub">
                    {{ s.mobile || 'لا يوجد رقم جوال' }}
                  </div>
                </div>

                <a
                  class="row-action"
                  *ngIf="s.mobile"
                  [href]="buildWhatsAppLink(s.mobile)"
                  (click)="$event.stopPropagation()"
                >
                  <i class="ti ti-brand-whatsapp"></i>
                  <span>واتساب</span>
                </a>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </section>
    </div>
  </app-scrollbar>
</mat-dialog-content>
